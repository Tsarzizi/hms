SQL1

-- 定义参数，方便调整时间范围
WITH params AS (
  SELECT 
    (CURRENT_DATE - INTERVAL '12 day')::date AS start_date,  -- 起始日期：13天前
    (CURRENT_DATE + INTERVAL '1 day')::date   AS end_date    -- 结束日期：明天（不含）
),

dep_incom AS (
  -- 第一部分：从 t_workload_inp_f 汇总每日的费用和数量
  SELECT
      i.rcpt_date::date                AS rcpt_date,      -- 收费日期
      i.patient_in_dept                AS dep_code,       -- 科室编码
      d."绩效科室名称"                  AS dep_name,       -- 科室名称
      i.item_name,                                     
      i.item_code,
      i.item_class_name,
      SUM(i.charges)                   AS charges,        -- 总费用
      SUM(i.amount)                    AS amount          -- 总数量
  FROM t_workload_inp_f AS i
  LEFT JOIN t_workload_dep_def2his AS d
         ON d."HIS科室编码" = i.patient_in_dept
  JOIN params p ON TRUE
  WHERE i.rcpt_date >= p.start_date
    AND i.rcpt_date <  p.end_date
  GROUP BY
      i.rcpt_date,
      i.patient_in_dept,
      d."绩效科室名称",
      i.item_name,
      i.item_code,
      i.item_class_name

  UNION ALL

  -- 第二部分：从历史表 t_dep_income_inp 中取相同时间段的数据
  SELECT
      x.rcpt_date::date        AS rcpt_date,
      x.dep_code,
      x.dep_name,
      x.item_name,
      x.item_code,
      x.item_class_name,
      x.charges,
      x.amount
  FROM t_dep_income_inp AS x
  JOIN params p ON TRUE
  WHERE x.rcpt_date >= p.start_date
    AND x.rcpt_date <  p.end_date
)

-- 最终结果输出
SELECT
  rcpt_date,
  dep_code,
  dep_name,
  item_name,
  item_code,
  item_class_name,
  charges,
  amount
FROM dep_incom
ORDER BY rcpt_date, dep_code, item_code;




SQL2

-- 定义时间参数，便于维护和复用
WITH params AS (
  SELECT 
    CURRENT_DATE AS today,
    (CURRENT_DATE + INTERVAL '1 day')::date AS tomorrow
),

inbed_data AS (
  -- ✅ 当天数据：从实时登记表汇总
  SELECT 
      i.adm_date::date AS inbed_date,       -- 入院日期
      i.adm_dept_code AS dep_code,          -- 科室编码
      i.adm_dept_name AS dep_name,          -- 科室名称
      COUNT(i.mdtrt_id) AS amount           -- 在院人数
  FROM t_workload_inbed_reg_f AS i
  JOIN params p ON TRUE
  WHERE i.adm_date >= p.today 
    AND i.adm_date <  p.tomorrow
  GROUP BY i.adm_date, i.adm_dept_code, i.adm_dept_name

  UNION ALL

  -- ✅ 历史汇总数据
  SELECT 
      h.inbed_date,
      h.dep_code,
      h.dep_name,
      h.amount
  FROM t_dep_count_inbed AS h
  JOIN params p ON TRUE
  WHERE h.inbed_date < p.today
)

-- ✅ 输出合并结果
SELECT 
    inbed_date,
    dep_code,
    dep_name,
    amount
FROM inbed_data
ORDER BY inbed_date DESC, amount DESC;

