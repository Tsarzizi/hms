
sql参考



```sql

`SELECT yyyy_mm,`
    `"绩效科室ID",`
    `"绩效科室名称",`
    `"绩效科室类别",`
    `"绩效科室类型",`
    `"同类序号",`
    `COALESCE("人数", 0) AS "人数",`
    `COALESCE("结算收入", 0) AS "结算收入",`
    `COALESCE("科室直接成本", 0) AS "科室直接成本",`
    `COALESCE("绩效总额", 0) AS "绩效总额",`
    `COALESCE("绩效总额", 0) / NULLIF(COALESCE("人数", 0), 0) AS "人均绩效",`
    `COALESCE("住院工作量点数", 0) AS "住院工作量点数",`
    `COALESCE("工作量单价", 0) AS "工作量单价",`
    `COALESCE("工作量系数", 0) AS "工作量系数",`
    `COALESCE("住院工作量绩效非手术介入", 0) AS "住院工作量绩效非手术介入",`
    `COALESCE("基础手术绩效", 0) AS "基础手术绩效",`
    `COALESCE("介入绩效", 0) AS "介入绩效",`
    `COALESCE("造影绩效", 0) AS "造影绩效",`
    `COALESCE("结算收入", 0) AS "结算费用",`
    `COALESCE("病种成本", 0) AS "DRG病种成本",`
    `COALESCE("DRG结余", 0) AS "DRG结余",`
    `COALESCE("drg系数", 0) AS "drg系数",`
    `COALESCE("DRG绩效", 0) AS "DRG绩效",`
    `COALESCE("门诊工作量点数", 0) AS "门诊工作量点数",`
    `COALESCE("门诊工作量绩效非手术介入", 0) AS "门诊工作量绩效非手术介入",`
    `COALESCE("门诊基础手术绩效", 0) AS "门诊基础手术绩效",`
    `COALESCE("门诊介入绩效", 0) AS "门诊介入绩效",`
    `COALESCE("门诊造影绩效", 0) AS "门诊造影绩效",`
    `COALESCE("挂号费奖励", 0) AS "挂号费奖励",`
    `COALESCE("诊察费奖励", 0) AS "诊察费奖励",`
    `COALESCE("三级手术奖励", 0) AS "三级手术奖励",`
    `COALESCE("四级手术奖励", 0) AS "四级手术奖励",`
    `COALESCE("单项奖励合计", 0) AS "单项奖励合计"`
   `FROM m_v_workload_doc_perform_total`
`union` 
`SELECT yyyy_mm,`
    `"绩效科室ID",`
    `"绩效科室名称",`
    `"绩效科室类别",`
    `"绩效科室类型",`
    `"同类序号",`
    `COALESCE("人数", 0) AS "人数",`
    `COALESCE("结算收入", 0) AS "结算收入",`
    `COALESCE("科室直接成本", 0) AS "科室直接成本",`
    `COALESCE("绩效总额", 0) AS "绩效总额",`
    `COALESCE("绩效总额", 0) / NULLIF(COALESCE("人数", 0), 0) AS "人均绩效",`
    `COALESCE("住院工作量点数", 0) AS "住院工作量点数",`
    `COALESCE("工作量单价", 0) AS "工作量单价",`
    `COALESCE("工作量系数", 0) AS "工作量系数",`
    `COALESCE("住院工作量绩效非手术介入", 0) AS "住院工作量绩效非手术介入",`
    `COALESCE("基础手术绩效", 0) AS "基础手术绩效",`
    `COALESCE("介入绩效", 0) AS "介入绩效",`
    `COALESCE("造影绩效", 0) AS "造影绩效",`
    `COALESCE("结算收入", 0) AS "结算费用",`
    `COALESCE("病种成本", 0) AS "DRG病种成本",`
    `COALESCE("DRG结余", 0) AS "DRG结余",`
    `COALESCE("drg系数", 0) AS "drg系数",`
    `COALESCE("DRG绩效", 0) AS "DRG绩效",`
    `COALESCE("门诊工作量点数", 0) AS "门诊工作量点数",`
    `COALESCE("门诊工作量绩效非手术介入", 0) AS "门诊工作量绩效非手术介入",`
    `COALESCE("门诊基础手术绩效", 0) AS "门诊基础手术绩效",`
    `COALESCE("门诊介入绩效", 0) AS "门诊介入绩效",`
    `COALESCE("门诊造影绩效", 0) AS "门诊造影绩效",`
    `COALESCE("挂号费奖励", 0) AS "挂号费奖励",`
    `COALESCE("诊察费奖励", 0) AS "诊察费奖励",`
    `COALESCE("三级手术奖励", 0) AS "三级手术奖励",`
    `COALESCE("四级手术奖励", 0) AS "四级手术奖励",`
    `COALESCE("单项奖励合计", 0) AS "单项奖励合计"`
    `from m_v_workload_dep_perform_total`
`WHERE` 
   `yyyy_mm = :yyyy_mm` 
`ORDER BY  yyyy_mm,"绩效科室类别","同类序号"`
```







m_v_workload_doc_perform_total定义

```
WITH date_range AS (
         SELECT DISTINCT t_workload_inp.yyyy_mm
           FROM t_workload_inp
        ), department_info AS (
         SELECT DISTINCT t_workload_dep_def."绩效科室ID",
            t_workload_dep_def."绩效科室名称",
            t_workload_dep_def."绩效科室属性",
            t_workload_dep_def."绩效科室类别",
            t_workload_dep_def."绩效科室类型",
            t_workload_dep_def."工作量单价",
            t_workload_dep_def."门诊工作量单价",
            t_workload_dep_def."工作量系数",
            t_workload_dep_def."人数",
            t_workload_dep_def."同类序号"
           FROM t_workload_dep_def
        ), main_data AS (
         SELECT d.yyyy_mm,
            h."绩效科室ID",
            h."绩效科室名称",
            h."绩效科室属性",
            h."绩效科室类别",
            h."绩效科室类型",
            h."工作量单价",
            h."门诊工作量单价",
            h."工作量系数",
            h."人数",
            h."同类序号"
           FROM (date_range d
             CROSS JOIN department_info h)
        ), income_data AS (
         SELECT combined_data.yyyy_mm,
            combined_data.department,
            sum(combined_data.costs) AS total_cost
           FROM ( SELECT t_workload_inp.yyyy_mm,
                    t_workload_inp.patient_in_dept AS department,
                    t_workload_inp.costs
                   FROM t_workload_inp
                UNION ALL
                 SELECT t_workload_outp.yyyy_mm,
                    t_workload_outp.ordered_by AS department,
                    t_workload_outp.costs
                   FROM t_workload_outp) combined_data
          GROUP BY combined_data.yyyy_mm, combined_data.department
        ), department_income AS (
         SELECT s.yyyy_mm,
            h."绩效科室ID",
            sum(s.total_cost) AS total_income
           FROM (income_data s
             LEFT JOIN t_workload_dep_def2his h ON (((h."HIS科室编码")::text = (s.department)::text)))
          GROUP BY s.yyyy_mm, h."绩效科室ID"
        ), workload_metrics_all AS (
         SELECT v_workload_matrix_award.yyyy_mm,
            v_workload_matrix_award."绩效科室ID",
            v_workload_matrix_award."绩效科室名称",
            v_workload_matrix_award.doctor_id,
            v_workload_matrix_award.doctor_name,
            v_workload_matrix_award.inp_zcfjl,
            v_workload_matrix_award.inp_ghfjl,
            v_workload_matrix_award.inp_zyjx,
            v_workload_matrix_award.inp_jrjx,
            v_workload_matrix_award.inp_ssjx,
            v_workload_matrix_award.inp_bill,
            v_workload_matrix_award.inp_zxjx,
            v_workload_matrix_award.outp_zcfjl,
            v_workload_matrix_award.outp_ghfjl,
            v_workload_matrix_award.outp_zyjx,
            v_workload_matrix_award.outp_jrjx,
            v_workload_matrix_award.outp_ssjx,
            v_workload_matrix_award.outp_bill,
            v_workload_matrix_award.outp_zxjx,
            v_workload_matrix_award.surgery_award_3,
            v_workload_matrix_award.surgery_award_4,
            v_workload_matrix_award.total_surgery_award,
            v_workload_matrix_award.inp_nurse,
            v_workload_matrix_award.outp_nurse
           FROM v_workload_matrix_award
        UNION
         SELECT v_workload_matrix_doc_inp.yyyy_mm,
            v_workload_matrix_doc_inp."绩效科室ID",
            v_workload_matrix_doc_inp."绩效科室名称",
            v_workload_matrix_doc_inp.doctor_id,
            v_workload_matrix_doc_inp.doctor_name,
            v_workload_matrix_doc_inp.inp_zcfjl,
            v_workload_matrix_doc_inp.inp_ghfjl,
            v_workload_matrix_doc_inp.inp_zyjx,
            v_workload_matrix_doc_inp.inp_jrjx,
            v_workload_matrix_doc_inp.inp_ssjx,
            v_workload_matrix_doc_inp.inp_bill,
            v_workload_matrix_doc_inp.inp_zxjx,
            v_workload_matrix_doc_inp.outp_zcfjl,
            v_workload_matrix_doc_inp.outp_ghfjl,
            v_workload_matrix_doc_inp.outp_zyjx,
            v_workload_matrix_doc_inp.outp_jrjx,
            v_workload_matrix_doc_inp.outp_ssjx,
            v_workload_matrix_doc_inp.outp_bill,
            v_workload_matrix_doc_inp.outp_zxjx,
            v_workload_matrix_doc_inp.surgery_award_3,
            v_workload_matrix_doc_inp.surgery_award_4,
            v_workload_matrix_doc_inp.total_surgery_award,
            v_workload_matrix_doc_inp.inp_nurse,
            v_workload_matrix_doc_inp.outp_nurse
           FROM v_workload_matrix_doc_inp
        UNION
         SELECT v_workload_matrix_doc_outp.yyyy_mm,
            v_workload_matrix_doc_outp."绩效科室ID",
            v_workload_matrix_doc_outp."绩效科室名称",
            v_workload_matrix_doc_outp.doctor_id,
            v_workload_matrix_doc_outp.doctor_name,
            v_workload_matrix_doc_outp.inp_zcfjl,
            v_workload_matrix_doc_outp.inp_ghfjl,
            v_workload_matrix_doc_outp.inp_zyjx,
            v_workload_matrix_doc_outp.inp_jrjx,
            v_workload_matrix_doc_outp.inp_ssjx,
            v_workload_matrix_doc_outp.inp_bill,
            v_workload_matrix_doc_outp.inp_zxjx,
            v_workload_matrix_doc_outp.outp_zcfjl,
            v_workload_matrix_doc_outp.outp_ghfjl,
            v_workload_matrix_doc_outp.outp_zyjx,
            v_workload_matrix_doc_outp.outp_jrjx,
            v_workload_matrix_doc_outp.outp_ssjx,
            v_workload_matrix_doc_outp.outp_bill,
            v_workload_matrix_doc_outp.outp_zxjx,
            v_workload_matrix_doc_outp.surgery_award_3,
            v_workload_matrix_doc_outp.surgery_award_4,
            v_workload_matrix_doc_outp.total_surgery_award,
            v_workload_matrix_doc_outp.inp_nurse,
            v_workload_matrix_doc_outp.outp_nurse
           FROM v_workload_matrix_doc_outp
        ), workload_metrics AS (
         SELECT workload_metrics_all.yyyy_mm,
            workload_metrics_all."绩效科室ID",
            workload_metrics_all."绩效科室名称",
            sum(workload_metrics_all.inp_zcfjl) AS total_inp_zcfjl,
            sum(workload_metrics_all.inp_ghfjl) AS total_inp_ghfjl,
            sum(workload_metrics_all.inp_zyjx) AS total_inp_zyjx,
            sum(workload_metrics_all.inp_jrjx) AS total_inp_jrjx,
            sum(workload_metrics_all.inp_ssjx) AS total_inp_ssjx,
            sum(workload_metrics_all.inp_bill) AS total_inp_bill,
            sum(workload_metrics_all.inp_zxjx) AS total_inp_zxjx,
            sum(workload_metrics_all.outp_zcfjl) AS total_outp_zcfjl,
            sum(workload_metrics_all.outp_ghfjl) AS total_outp_ghfjl,
            sum(workload_metrics_all.outp_zyjx) AS total_outp_zyjx,
            sum(workload_metrics_all.outp_jrjx) AS total_outp_jrjx,
            sum(workload_metrics_all.outp_ssjx) AS total_outp_ssjx,
            sum(workload_metrics_all.outp_bill) AS total_outp_bill,
            sum(workload_metrics_all.outp_zxjx) AS total_outp_zxjx,
            sum(workload_metrics_all.inp_nurse) AS total_inp_nurse,
            sum(workload_metrics_all.outp_nurse) AS total_outp_nurse,
            sum(workload_metrics_all.surgery_award_3) AS surgery_award_3,
            sum(workload_metrics_all.surgery_award_4) AS surgery_award_4
           FROM workload_metrics_all
          GROUP BY workload_metrics_all.yyyy_mm, workload_metrics_all."绩效科室ID", workload_metrics_all."绩效科室名称"
        ), award_metrics AS (
         SELECT v_workload_matrix_award.yyyy_mm,
            v_workload_matrix_award."绩效科室ID",
            v_workload_matrix_award."绩效科室名称",
            sum(v_workload_matrix_award.outp_zcfjl) AS total_outp_zcfjl,
            sum(v_workload_matrix_award.outp_ghfjl) AS total_outp_ghfjl,
            sum(v_workload_matrix_award.surgery_award_3) AS total_surgery_award_3,
            sum(v_workload_matrix_award.surgery_award_4) AS total_surgery_award_4,
            sum(v_workload_matrix_award.total_surgery_award) AS total_surgery_award_sum
           FROM v_workload_matrix_award
          GROUP BY v_workload_matrix_award.yyyy_mm, v_workload_matrix_award."绩效科室ID", v_workload_matrix_award."绩效科室名称"
        ), cost_metrics AS (
         SELECT v_workload_dep_cost_month."年月" AS yyyy_mm,
            v_workload_dep_cost_month."绩效科室ID",
            COALESCE(v_workload_dep_cost_month."科室直接成本", (0)::numeric) AS "科室直接成本",
            COALESCE(v_workload_dep_cost_month."人员工资", (0)::numeric) AS "人员工资",
            COALESCE(v_workload_dep_cost_month."五险一金", (0)::numeric) AS "五险一金",
            COALESCE(v_workload_dep_cost_month."卫生材料", (0)::numeric) AS "卫生材料",
            COALESCE(v_workload_dep_cost_month."其他材料", (0)::numeric) AS "其他材料",
            COALESCE(v_workload_dep_cost_month."固定资产折旧", (0)::numeric) AS "固定资产折旧",
            COALESCE(v_workload_dep_cost_month."无形资产摊销", (0)::numeric) AS "无形资产摊销",
            COALESCE(v_workload_dep_cost_month."维修（护）费", (0)::numeric) AS "维修（护）费",
            COALESCE(v_workload_dep_cost_month."培训费", (0)::numeric) AS "培训费",
            COALESCE(v_workload_dep_cost_month."水费", (0)::numeric) AS "水费",
            COALESCE(v_workload_dep_cost_month."电费", (0)::numeric) AS "电费"
           FROM v_workload_dep_cost_month
        ), drg_metrics AS (
         SELECT v."年月",
            d."绩效科室ID",
            sum(v."DRG绩效") AS "DRG绩效总和",
            sum(v."总费用") AS "总费用总和",
            sum(v."总成本") AS "总成本总和"
           FROM (v_workload_drg_bill_detail v
             JOIN t_workload_dep_def2his d ON (((d."HIS科室编码")::text = (v."费用发生科室")::text)))
          WHERE (v."转科" IS NULL)
          GROUP BY v."年月", d."绩效科室ID"
        ), performance_calculations AS (
         SELECT main.yyyy_mm,
            main."绩效科室ID",
            main."绩效科室名称",
            main."绩效科室属性",
            main."绩效科室类别",
            main."绩效科室类型",
            main."工作量单价",
            main."门诊工作量单价",
            main."工作量系数",
            main."人数",
            main."同类序号",
            COALESCE(income.total_income, (0)::numeric) AS "总收入",
            COALESCE(aw.total_outp_zcfjl, (0)::numeric) AS "诊察费奖励",
            COALESCE(aw.total_outp_ghfjl, (0)::numeric) AS "挂号费奖励",
            COALESCE(aw.total_surgery_award_3, (0)::numeric) AS "三级手术奖励",
            COALESCE(aw.total_surgery_award_4, (0)::numeric) AS "四级手术奖励",
            COALESCE(wk.total_inp_zyjx, (0)::numeric) AS "造影绩效",
            COALESCE(wk.total_inp_jrjx, (0)::numeric) AS "介入绩效",
            COALESCE(wk.total_inp_bill, (0)::numeric) AS "开单点数",
            COALESCE(wk.total_inp_zxjx, (0)::numeric) AS "执行点数",
            COALESCE(wk.total_inp_ssjx, (0)::numeric) AS "基础手术绩效",
            COALESCE(wk.total_inp_nurse, (0)::numeric) AS "护理点数",
            COALESCE(wk.total_outp_zyjx, (0)::numeric) AS "门诊造影绩效",
            COALESCE(wk.total_outp_jrjx, (0)::numeric) AS "门诊介入绩效",
            COALESCE(wk.total_outp_bill, (0)::numeric) AS "门诊开单点数",
            COALESCE(wk.total_outp_zxjx, (0)::numeric) AS "门诊执行点数",
            COALESCE(wk.total_outp_ssjx, (0)::numeric) AS "门诊基础手术绩效",
            COALESCE(wk.total_outp_nurse, (0)::numeric) AS "门诊护理点数",
            COALESCE(drg."总成本总和", (0)::numeric) AS "病种成本",
            COALESCE(drg."总费用总和", (0)::numeric) AS "病种收入",
            COALESCE(drg."DRG绩效总和", (0)::numeric) AS "DRG结余",
            COALESCE(cost."科室直接成本", (0)::numeric) AS "科室直接成本",
            COALESCE(cost."人员工资", (0)::numeric) AS "人员工资",
            COALESCE(cost."五险一金", (0)::numeric) AS "五险一金",
            COALESCE(cost."卫生材料", (0)::numeric) AS "卫生材料",
            COALESCE(cost."其他材料", (0)::numeric) AS "其他材料",
            COALESCE(cost."固定资产折旧", (0)::numeric) AS "固定资产折旧",
            COALESCE(cost."无形资产摊销", (0)::numeric) AS "无形资产摊销",
            COALESCE(cost."维修（护）费", (0)::numeric) AS "维修（护）费",
            COALESCE(cost."培训费", (0)::numeric) AS "培训费",
            COALESCE(cost."水费", (0)::numeric) AS "水费",
            COALESCE(cost."电费", (0)::numeric) AS "电费",
            (COALESCE(wk.total_inp_bill, (0)::numeric) + COALESCE(wk.total_inp_zxjx, (0)::numeric)) AS inp_work_points,
            (COALESCE(wk.total_outp_bill, (0)::numeric) + COALESCE(wk.total_outp_zxjx, (0)::numeric)) AS outp_work_points,
            (((COALESCE(wk.total_inp_bill, (0)::numeric) + COALESCE(wk.total_inp_zxjx, (0)::numeric)) + COALESCE(wk.total_outp_bill, (0)::numeric)) + COALESCE(wk.total_outp_zxjx, (0)::numeric)) AS work_points,
            (COALESCE(wk.total_inp_nurse, (0)::numeric) + COALESCE(wk.total_outp_nurse, (0)::numeric)) AS total_nursing_points,
            (((COALESCE(wk.total_inp_bill, (0)::numeric) + COALESCE(wk.total_inp_zxjx, (0)::numeric)) * COALESCE(main."工作量单价", (0)::numeric)) * COALESCE(main."工作量系数", (1)::numeric)) AS inp_work_performance,
            (((COALESCE(wk.total_outp_bill, (0)::numeric) + COALESCE(wk.total_outp_zxjx, (0)::numeric)) * COALESCE(main."门诊工作量单价", (0)::numeric)) * COALESCE(main."工作量系数", (1)::numeric)) AS outp_work_performance,
            ((((COALESCE(wk.total_inp_bill, (0)::numeric) + COALESCE(wk.total_inp_zxjx, (0)::numeric)) * COALESCE(main."工作量单价", (0)::numeric)) * COALESCE(main."工作量系数", (1)::numeric)) + (((COALESCE(wk.total_outp_bill, (0)::numeric) + COALESCE(wk.total_outp_zxjx, (0)::numeric)) * COALESCE(main."门诊工作量单价", (0)::numeric)) * COALESCE(main."工作量系数", (1)::numeric))) AS work_performance,
            (((COALESCE(wk.total_inp_nurse, (0)::numeric) + COALESCE(wk.total_outp_nurse, (0)::numeric)) * COALESCE(main."工作量单价", (0)::numeric)) * COALESCE(main."工作量系数", (1)::numeric)) AS nurse_performance,
            (((COALESCE(aw.total_surgery_award_3, (0)::numeric) + COALESCE(aw.total_surgery_award_4, (0)::numeric)) + COALESCE(aw.total_outp_zcfjl, (0)::numeric)) + COALESCE(aw.total_outp_ghfjl, (0)::numeric)) AS work_bonus,
            (((((COALESCE(wk.total_inp_bill, (0)::numeric) + COALESCE(wk.total_inp_zxjx, (0)::numeric)) * COALESCE(main."工作量单价", (0)::numeric)) * COALESCE(main."工作量系数", (1)::numeric)) + (((COALESCE(wk.total_outp_bill, (0)::numeric) + COALESCE(wk.total_outp_zxjx, (0)::numeric)) * COALESCE(main."门诊工作量单价", (0)::numeric)) * COALESCE(main."工作量系数", (1)::numeric))) + (((((COALESCE(wk.total_inp_ssjx, (0)::numeric) + COALESCE(wk.total_inp_zyjx, (0)::numeric)) + COALESCE(wk.total_inp_jrjx, (0)::numeric)) + COALESCE(wk.total_outp_ssjx, (0)::numeric)) + COALESCE(wk.total_outp_zyjx, (0)::numeric)) + COALESCE(wk.total_outp_jrjx, (0)::numeric))) AS total_work_performance,
                CASE
                    WHEN ((main."绩效科室类型")::text = '外科'::text) THEN 0.11
                    WHEN ((main."绩效科室类型")::text = '内科'::text) THEN 0.09
                    WHEN ((main."绩效科室类型")::text = '重症'::text) THEN 0.09
                    ELSE (0)::numeric
                END AS difference_coefficient
           FROM (((((main_data main
             LEFT JOIN workload_metrics wk ON ((((main.yyyy_mm)::text = (wk.yyyy_mm)::text) AND ((main."绩效科室ID")::text = (wk."绩效科室ID")::text))))
             LEFT JOIN award_metrics aw ON ((((main.yyyy_mm)::text = (aw.yyyy_mm)::text) AND ((main."绩效科室ID")::text = (aw."绩效科室ID")::text))))
             LEFT JOIN cost_metrics cost ON ((((main.yyyy_mm)::text = (cost.yyyy_mm)::text) AND ((main."绩效科室ID")::text = (cost."绩效科室ID")::text))))
             LEFT JOIN drg_metrics drg ON ((((main.yyyy_mm)::text = drg."年月") AND ((main."绩效科室ID")::text = (drg."绩效科室ID")::text))))
             LEFT JOIN department_income income ON ((((main.yyyy_mm)::text = (income.yyyy_mm)::text) AND ((main."绩效科室ID")::text = (income."绩效科室ID")::text))))
        )
 SELECT yyyy_mm,
    "绩效科室ID",
    "绩效科室名称",
    "绩效科室属性",
    "绩效科室类别",
    "绩效科室类型",
    "同类序号",
    "工作量单价",
    "门诊工作量单价",
    "工作量系数",
    "人数",
    "总收入" AS "结算收入",
    "科室直接成本",
    (((work_performance + ("DRG结余" * difference_coefficient)) - "科室直接成本"))::numeric(10,2) AS "工作量DRG绩效总和",
    (inp_work_points)::numeric(10,4) AS "住院工作量点数",
    (outp_work_points)::numeric(10,4) AS "门诊工作量点数",
    (work_points)::numeric(10,4) AS "工作量点数",
    (total_nursing_points)::numeric(10,2) AS "护理工作量点数",
    (nurse_performance)::numeric(10,2) AS "护理工作量绩效",
    (inp_work_performance)::numeric(10,2) AS "住院工作量绩效非手术介入",
    (outp_work_performance)::numeric(10,2) AS "门诊工作量绩效非手术介入",
    (work_performance)::numeric(10,2) AS "工作量绩效非手术介入",
    (work_bonus)::numeric(10,2) AS "单项奖励合计",
    (total_work_performance)::numeric(10,2) AS "工作量总绩效",
    "病种收入",
    "病种成本",
    "DRG结余",
    difference_coefficient AS "drg系数",
    (("DRG结余" * difference_coefficient))::numeric(10,2) AS "DRG绩效",
    (((total_work_performance + ("DRG结余" * difference_coefficient)) - "科室直接成本"))::numeric(10,2) AS "绩效总额",
    "三级手术奖励",
    "四级手术奖励",
    "造影绩效",
    "介入绩效",
    "开单点数",
    "执行点数",
    "基础手术绩效",
    "护理点数",
    "诊察费奖励",
    "挂号费奖励",
    "门诊造影绩效",
    "门诊介入绩效",
    "门诊开单点数",
    "门诊执行点数",
    "门诊基础手术绩效",
    "门诊护理点数",
    "人员工资",
    "五险一金",
    "卫生材料",
    "其他材料",
    "固定资产折旧",
    "无形资产摊销",
    "维修（护）费",
    "培训费",
    "水费",
    "电费"
   FROM performance_calculations
  WHERE (("绩效科室类别")::text = ANY ((ARRAY['临床'::character varying, '门诊'::character varying])::text[]))
  ORDER BY "绩效科室类别", "绩效科室类型", "同类序号"
```



m_v_workload_doc_perform_total表定义



```sql
WITH date_range AS (
         SELECT DISTINCT t_workload_inp.yyyy_mm
           FROM t_workload_inp
        ), department_info AS (
         SELECT DISTINCT t_workload_dep_def."绩效科室ID",
            t_workload_dep_def."绩效科室名称",
            t_workload_dep_def."绩效科室属性",
            t_workload_dep_def."绩效科室类别",
            t_workload_dep_def."绩效科室类型",
            t_workload_dep_def."工作量单价",
            t_workload_dep_def."工作量系数",
            t_workload_dep_def."人数",
            t_workload_dep_def."同类序号"
           FROM t_workload_dep_def
        ), main_data AS (
         SELECT d.yyyy_mm,
            h."绩效科室ID",
            h."绩效科室名称",
            h."绩效科室属性",
            h."绩效科室类别",
            h."绩效科室类型",
            h."工作量单价",
            h."工作量系数",
            h."人数",
            h."同类序号"
           FROM (date_range d
             CROSS JOIN department_info h)
        ), income_data AS (
         SELECT combined_data.yyyy_mm,
            combined_data.department,
            sum(combined_data.costs) AS total_cost
           FROM ( SELECT t_workload_inp.yyyy_mm,
                    t_workload_inp.patient_in_dept AS department,
                    t_workload_inp.costs
                   FROM t_workload_inp
                UNION ALL
                 SELECT t_workload_outp.yyyy_mm,
                    t_workload_outp.ordered_by AS department,
                    t_workload_outp.costs
                   FROM t_workload_outp) combined_data
          GROUP BY combined_data.yyyy_mm, combined_data.department
        ), department_income AS (
         SELECT s.yyyy_mm,
            h."绩效科室ID",
            sum(s.total_cost) AS total_income
           FROM (income_data s
             LEFT JOIN t_workload_dep_def2his h ON (((h."HIS科室编码")::text = (s.department)::text)))
          GROUP BY s.yyyy_mm, h."绩效科室ID"
        ), workload_metrics_1 AS (
         SELECT v_workload_matrix.yyyy_mm,
            v_workload_matrix."绩效科室ID",
            sum(v_workload_matrix.inp_zyjx) AS total_inp_zyjx,
            sum(v_workload_matrix.inp_jrjx) AS total_inp_jrjx,
            sum(v_workload_matrix.inp_ssjx) AS total_inp_ssjx,
            sum(v_workload_matrix.inp_bill) AS total_inp_bill,
            sum(v_workload_matrix.inp_zxjx) AS total_inp_zxjx,
            sum(v_workload_matrix.outp_zyjx) AS total_outp_zyjx,
            sum(v_workload_matrix.outp_jrjx) AS total_outp_jrjx,
            sum(v_workload_matrix.outp_ssjx) AS total_outp_ssjx,
            sum(v_workload_matrix.outp_bill) AS total_outp_bill,
            sum(v_workload_matrix.outp_zxjx) AS total_outp_zxjx,
            sum(v_workload_matrix.inp_nurse) AS total_inp_nurse,
            sum(v_workload_matrix.outp_nurse) AS total_outp_nurse
           FROM v_workload_matrix
          GROUP BY v_workload_matrix.yyyy_mm, v_workload_matrix."绩效科室ID"
        ), workload_metrics AS (
         SELECT workload_metrics_1.yyyy_mm,
            workload_metrics_1."绩效科室ID",
            sum(workload_metrics_1.total_inp_zyjx) AS total_inp_zyjx,
            sum(workload_metrics_1.total_inp_jrjx) AS total_inp_jrjx,
            sum(workload_metrics_1.total_inp_ssjx) AS total_inp_ssjx,
            sum(workload_metrics_1.total_inp_bill) AS total_inp_bill,
            sum(workload_metrics_1.total_inp_zxjx) AS total_inp_zxjx,
            sum(workload_metrics_1.total_outp_zyjx) AS total_outp_zyjx,
            sum(workload_metrics_1.total_outp_jrjx) AS total_outp_jrjx,
            sum(workload_metrics_1.total_outp_ssjx) AS total_outp_ssjx,
            sum(workload_metrics_1.total_outp_bill) AS total_outp_bill,
            sum(workload_metrics_1.total_outp_zxjx) AS total_outp_zxjx,
            sum(workload_metrics_1.total_inp_nurse) AS total_inp_nurse,
            sum(workload_metrics_1.total_outp_nurse) AS total_outp_nurse
           FROM workload_metrics_1
          GROUP BY workload_metrics_1.yyyy_mm, workload_metrics_1."绩效科室ID"
        ), award_metrics AS (
         SELECT v_workload_matrix_award.yyyy_mm,
            v_workload_matrix_award."绩效科室ID",
            v_workload_matrix_award."绩效科室名称",
            sum(v_workload_matrix_award.outp_zcfjl) AS total_outp_zcfjl,
            sum(v_workload_matrix_award.outp_ghfjl) AS total_outp_ghfjl,
            sum(v_workload_matrix_award.surgery_award_3) AS total_surgery_award_3,
            sum(v_workload_matrix_award.surgery_award_4) AS total_surgery_award_4,
            sum(v_workload_matrix_award.total_surgery_award) AS total_surgery_award_sum
           FROM v_workload_matrix_award
          GROUP BY v_workload_matrix_award.yyyy_mm, v_workload_matrix_award."绩效科室ID", v_workload_matrix_award."绩效科室名称"
        ), cost_metrics AS (
         SELECT v_workload_dep_cost_month."年月" AS yyyy_mm,
            v_workload_dep_cost_month."绩效科室ID",
            COALESCE(v_workload_dep_cost_month."科室直接成本", (0)::numeric) AS "科室直接成本",
            COALESCE(v_workload_dep_cost_month."人员工资", (0)::numeric) AS "人员工资",
            COALESCE(v_workload_dep_cost_month."五险一金", (0)::numeric) AS "五险一金",
            COALESCE(v_workload_dep_cost_month."卫生材料", (0)::numeric) AS "卫生材料",
            COALESCE(v_workload_dep_cost_month."其他材料", (0)::numeric) AS "其他材料",
            COALESCE(v_workload_dep_cost_month."固定资产折旧", (0)::numeric) AS "固定资产折旧",
            COALESCE(v_workload_dep_cost_month."无形资产摊销", (0)::numeric) AS "无形资产摊销",
            COALESCE(v_workload_dep_cost_month."维修（护）费", (0)::numeric) AS "维修（护）费",
            COALESCE(v_workload_dep_cost_month."培训费", (0)::numeric) AS "培训费",
            COALESCE(v_workload_dep_cost_month."水费", (0)::numeric) AS "水费",
            COALESCE(v_workload_dep_cost_month."电费", (0)::numeric) AS "电费"
           FROM v_workload_dep_cost_month
        ), drg_metrics AS (
         SELECT v."年月",
            d."绩效科室ID",
            sum(v."DRG绩效") AS "DRG绩效总和",
            sum(v."总费用") AS "总费用总和",
            sum(v."总成本") AS "总成本总和"
           FROM (v_workload_drg_bill_detail v
             JOIN t_workload_dep_def2his d ON (((d."HIS科室编码")::text = (v."费用发生科室")::text)))
          WHERE (v."转科" IS NULL)
          GROUP BY v."年月", d."绩效科室ID"
        ), performance_calculations AS (
         SELECT main.yyyy_mm,
            main."绩效科室ID",
            main."绩效科室名称",
            main."绩效科室属性",
            main."绩效科室类别",
            main."绩效科室类型",
            main."工作量单价",
            main."工作量系数",
            main."人数",
            main."同类序号",
            COALESCE(income.total_income, (0)::numeric) AS "总收入",
            COALESCE(aw.total_outp_zcfjl, (0)::numeric) AS "诊察费奖励",
            COALESCE(aw.total_outp_ghfjl, (0)::numeric) AS "挂号费奖励",
            COALESCE(aw.total_surgery_award_3, (0)::numeric) AS "三级手术奖励",
            COALESCE(aw.total_surgery_award_4, (0)::numeric) AS "四级手术奖励",
            COALESCE(wk.total_inp_zyjx, (0)::numeric) AS "造影绩效",
            COALESCE(wk.total_inp_jrjx, (0)::numeric) AS "介入绩效",
            COALESCE(wk.total_inp_bill, (0)::numeric) AS "开单点数",
            COALESCE(wk.total_inp_zxjx, (0)::numeric) AS "执行点数",
            COALESCE(wk.total_inp_ssjx, (0)::numeric) AS "基础手术绩效",
            COALESCE(wk.total_inp_nurse, (0)::numeric) AS "护理点数",
            COALESCE(wk.total_outp_zyjx, (0)::numeric) AS "门诊造影绩效",
            COALESCE(wk.total_outp_jrjx, (0)::numeric) AS "门诊介入绩效",
            COALESCE(wk.total_outp_bill, (0)::numeric) AS "门诊开单点数",
            COALESCE(wk.total_outp_zxjx, (0)::numeric) AS "门诊执行点数",
            COALESCE(wk.total_outp_ssjx, (0)::numeric) AS "门诊基础手术绩效",
            COALESCE(wk.total_outp_nurse, (0)::numeric) AS "门诊护理点数",
            COALESCE(drg."总成本总和", (0)::numeric) AS "病种成本",
            COALESCE(drg."总费用总和", (0)::numeric) AS "病种收入",
            COALESCE(drg."DRG绩效总和", (0)::numeric) AS "DRG结余",
            COALESCE(cost."科室直接成本", (0)::numeric) AS "科室直接成本",
            COALESCE(cost."人员工资", (0)::numeric) AS "人员工资",
            COALESCE(cost."五险一金", (0)::numeric) AS "五险一金",
            COALESCE(cost."卫生材料", (0)::numeric) AS "卫生材料",
            COALESCE(cost."其他材料", (0)::numeric) AS "其他材料",
            COALESCE(cost."固定资产折旧", (0)::numeric) AS "固定资产折旧",
            COALESCE(cost."无形资产摊销", (0)::numeric) AS "无形资产摊销",
            COALESCE(cost."维修（护）费", (0)::numeric) AS "维修（护）费",
            COALESCE(cost."培训费", (0)::numeric) AS "培训费",
            COALESCE(cost."水费", (0)::numeric) AS "水费",
            COALESCE(cost."电费", (0)::numeric) AS "电费",
            (COALESCE(wk.total_inp_bill, (0)::numeric) + COALESCE(wk.total_inp_zxjx, (0)::numeric)) AS inp_work_points,
            (COALESCE(wk.total_outp_bill, (0)::numeric) + COALESCE(wk.total_outp_zxjx, (0)::numeric)) AS outp_work_points,
            (((COALESCE(wk.total_inp_bill, (0)::numeric) + COALESCE(wk.total_inp_zxjx, (0)::numeric)) + COALESCE(wk.total_outp_bill, (0)::numeric)) + COALESCE(wk.total_outp_zxjx, (0)::numeric)) AS work_points,
            (COALESCE(wk.total_inp_nurse, (0)::numeric) + COALESCE(wk.total_outp_nurse, (0)::numeric)) AS total_nursing_points,
            (((COALESCE(wk.total_inp_bill, (0)::numeric) + COALESCE(wk.total_inp_zxjx, (0)::numeric)) * COALESCE(main."工作量单价", (0)::numeric)) * COALESCE(main."工作量系数", (1)::numeric)) AS inp_work_performance,
            (((COALESCE(wk.total_outp_bill, (0)::numeric) + COALESCE(wk.total_outp_zxjx, (0)::numeric)) * COALESCE(main."工作量单价", (0)::numeric)) * COALESCE(main."工作量系数", (1)::numeric)) AS outp_work_performance,
            ((((COALESCE(wk.total_inp_bill, (0)::numeric) + COALESCE(wk.total_inp_zxjx, (0)::numeric)) * COALESCE(main."工作量单价", (0)::numeric)) * COALESCE(main."工作量系数", (1)::numeric)) + (((COALESCE(wk.total_outp_bill, (0)::numeric) + COALESCE(wk.total_outp_zxjx, (0)::numeric)) * COALESCE(main."工作量单价", (0)::numeric)) * COALESCE(main."工作量系数", (1)::numeric))) AS work_performance,
            (((COALESCE(wk.total_inp_nurse, (0)::numeric) + COALESCE(wk.total_outp_nurse, (0)::numeric)) * COALESCE(main."工作量单价", (0)::numeric)) * COALESCE(main."工作量系数", (1)::numeric)) AS nurse_performance,
            (((COALESCE(aw.total_surgery_award_3, (0)::numeric) + COALESCE(aw.total_surgery_award_4, (0)::numeric)) + COALESCE(aw.total_outp_zcfjl, (0)::numeric)) + COALESCE(aw.total_outp_ghfjl, (0)::numeric)) AS work_bonus,
            (((((COALESCE(wk.total_inp_bill, (0)::numeric) + COALESCE(wk.total_inp_zxjx, (0)::numeric)) * COALESCE(main."工作量单价", (0)::numeric)) * COALESCE(main."工作量系数", (1)::numeric)) + (((COALESCE(wk.total_outp_bill, (0)::numeric) + COALESCE(wk.total_outp_zxjx, (0)::numeric)) * COALESCE(main."工作量单价", (0)::numeric)) * COALESCE(main."工作量系数", (1)::numeric))) + (((((COALESCE(wk.total_inp_ssjx, (0)::numeric) + COALESCE(wk.total_inp_zyjx, (0)::numeric)) + COALESCE(wk.total_inp_jrjx, (0)::numeric)) + COALESCE(wk.total_outp_ssjx, (0)::numeric)) + COALESCE(wk.total_outp_zyjx, (0)::numeric)) + COALESCE(wk.total_outp_jrjx, (0)::numeric))) AS total_work_performance,
                CASE
                    WHEN ((main."绩效科室类型")::text = '外科'::text) THEN 0.11
                    WHEN ((main."绩效科室类型")::text = '内科'::text) THEN 0.09
                    WHEN ((main."绩效科室类型")::text = '重症'::text) THEN 0.09
                    ELSE (0)::numeric
                END AS difference_coefficient
           FROM (((((main_data main
             LEFT JOIN workload_metrics wk ON ((((main.yyyy_mm)::text = (wk.yyyy_mm)::text) AND ((main."绩效科室ID")::text = (wk."绩效科室ID")::text))))
             LEFT JOIN award_metrics aw ON ((((main.yyyy_mm)::text = (aw.yyyy_mm)::text) AND ((main."绩效科室ID")::text = (aw."绩效科室ID")::text))))
             LEFT JOIN cost_metrics cost ON ((((main.yyyy_mm)::text = (cost.yyyy_mm)::text) AND ((main."绩效科室ID")::text = (cost."绩效科室ID")::text))))
             LEFT JOIN drg_metrics drg ON ((((main.yyyy_mm)::text = drg."年月") AND ((main."绩效科室ID")::text = (drg."绩效科室ID")::text))))
             LEFT JOIN department_income income ON ((((main.yyyy_mm)::text = (income.yyyy_mm)::text) AND ((main."绩效科室ID")::text = (income."绩效科室ID")::text))))
        )
 SELECT yyyy_mm,
    "绩效科室ID",
    "绩效科室名称",
    "绩效科室属性",
    "绩效科室类别",
    "绩效科室类型",
    "同类序号",
    "工作量单价",
    "工作量系数",
    "人数",
    "总收入" AS "结算收入",
    "科室直接成本",
    (((work_performance + ("DRG结余" * difference_coefficient)) - "科室直接成本"))::numeric(10,2) AS "工作量DRG绩效总和",
    (inp_work_points)::numeric(10,4) AS "住院工作量点数",
    (outp_work_points)::numeric(10,4) AS "门诊工作量点数",
    (work_points)::numeric(10,4) AS "工作量点数",
    (total_nursing_points)::numeric(10,2) AS "护理工作量点数",
    (nurse_performance)::numeric(10,2) AS "护理工作量绩效",
    (inp_work_performance)::numeric(10,2) AS "住院工作量绩效非手术介入",
    (outp_work_performance)::numeric(10,2) AS "门诊工作量绩效非手术介入",
    (work_performance)::numeric(10,2) AS "工作量绩效非手术介入",
    (work_bonus)::numeric(10,2) AS "单项奖励合计",
    (total_work_performance)::numeric(10,2) AS "工作量总绩效",
    "病种收入",
    "病种成本",
    "DRG结余",
    difference_coefficient AS "drg系数",
    (("DRG结余" * difference_coefficient))::numeric(10,2) AS "DRG绩效",
    (((total_work_performance + ("DRG结余" * difference_coefficient)) - "科室直接成本"))::numeric(10,2) AS "绩效总额",
    "三级手术奖励",
    "四级手术奖励",
    "造影绩效",
    "介入绩效",
    "开单点数",
    "执行点数",
    "基础手术绩效",
    "护理点数",
    "诊察费奖励",
    "挂号费奖励",
    "门诊造影绩效",
    "门诊介入绩效",
    "门诊开单点数",
    "门诊执行点数",
    "门诊基础手术绩效",
    "门诊护理点数",
    "人员工资",
    "五险一金",
    "卫生材料",
    "其他材料",
    "固定资产折旧",
    "无形资产摊销",
    "维修（护）费",
    "培训费",
    "水费",
    "电费"
   FROM performance_calculations
  WHERE (("绩效科室类别")::text = ANY (ARRAY[('医技'::character varying)::text, ('护理'::character varying)::text]))
  ORDER BY "绩效科室类别", "绩效科室类型", "同类序号"
```







