医院收入

住院

总收入



前端需要：部门列表、医生列表、总收入、总收入同比、总收入环比、总床日数、总床日数同比、总床日数环比
前端返回：日期间隔、开始日期、结束日期、部门、医生

后端返回：总收入、总收入同比、总收入环比、总床日数、总床日数同比、总床日数环比
后端需要：日期间隔、开始日期、结束日期、部门、医生



指标卡：

总收入、总床日数



同比环比分析：

总收入环比、总收入同比、总床日数同比、总床日数环比



图表：

日期、日期间隔、收入环比、收入同比、床日数同比、床日数环比



详情表单：

初始化（部门医生都是空）

| 日期 | 部门 | 收入 |
| ---- | ---- | ---- |

部门查询（携带部门查询）

| 日期 | 部门 | 项目 | 收入 | 数量 |
| ---- | ---- | ---- | ---- | ---- |

医生查询（携带部门和医生查询）

| 日期 | 部门 | 医生 | 项目 | 收入 | 数量 |
| ---- | ---- | ---- | ---- | ---- | ---- |



相关的表： 
物化视图t_dep_income_inp 	部门收入历史数据

| rcpt_date  | dep_code   | dep_name   | item_name     | item_code | item_class_name | charges | amount |
| ---------- | ---------- | ---------- | ------------- | --------- | --------------- | ------- | ------ |
| 2021-04-01 | 0001201207 | 妇产科病区 | ABO红细胞定型 | 260000001 | 化验费          | 3.60    | 1      |

物化视图t_doc_fee_inp		医生花费历史数据

| billing_date | doc_code | doc_name | item_name            | item_code | item_class_name | costs | amount |
| ------------ | -------- | -------- | -------------------- | --------- | --------------- | ----- | ------ |
| 2022-09-22   | 0550     | 银元     | 高频手术设备辅助操作 | 0092071   | 治疗费          | 75.00 | 1      |

表t_workload_doc_2dep_def	医生和部门的关系

| 工号 | 姓名 | 绩效科室ID | 绩效科室名称 | 其他1 | 其他2 | 其他3 | 其他4 | 其他5 |
| ---- | ---- | ---------- | ------------ | ----- | ----- | ----- | ----- | ----- |
| 8035 | 秦医 | 1144       | 妇产科病区   |       |       |       |       |       |

表t_workload_dep_def2his	部门和编码的关系

| 绩效科室名称 | HIS科室编码 |      |      |      |      |
| ------------ | ----------- | ---- | ---- | ---- | ---- |

表t_workload_inp_f			当日工作

| rcpt_id | patient_id | visit_id | fee_type | status_code | item_no | item_class | item_class_name | item_name | item_code | amount |      | patient_in_dept | costs | charges | billing_date_time | rcpt_date | order_doctor |      |      |
| ------- | ---------- | -------- | -------- | ----------- | ------- | ---------- | --------------- | --------- | --------- | ------ | ---- | --------------- | ----- | ------- | ----------------- | --------- | ------------ | ---- | ---- |
|         |            |          |          |             |         |            |                 |           |           |        |      |                 |       |         |                   |           |              |      |      |

物化视图t_dep_count_inbed	部门床日数历史数据

| inbed_date | dep_code | dep_name | amount |
| ---------- | -------- | -------- | ------ |

表对应关系

| 表名                    | 列名1        | 列名2    | 列名3      | 列名4        | 列名11          | 列名5        | 列名6     | 列名7   | 列名8 | 列名9           | 列名10 |
| ----------------------- | ------------ | -------- | ---------- | ------------ | --------------- | ------------ | --------- | ------- | ----- | --------------- | ------ |
| t_workload_doc_2dep_def | 工号         | 姓名     | 绩效科室ID | 绩效科室名称 |                 |              |           |         |       |                 |        |
| t_doc_fee_inp           | doc_code     | doc_name |            |              |                 | billing_date |           |         | costs | item_class_name | amount |
| t_dep_income_inp        |              |          |            | dep_name     | dep_code        |              | rcpt_date | charges |       | item_class_name | amount |
| t_workload_inp_f        | order_doctor |          |            |              | patient_in_dept | billing_date | rcpt_date | charges | costs | item_class_name | amount |
| t_workload_dep_def2his  |              |          |            | 绩效科室名称 | HIS科室编码     |              |           |         |       |                 |        |
| t_dep_count_inbed       |              |          |            |              |                 |              |           |         |       |                 |        |





问题：

部门编码问题：

1.求当前数据时，工作表查询时，工作表编码是his编码
2.绩效科室和his编码是1 v n，导致不能使用绩效科室名字查到his编码
3.历史视图数据使用的是绩效科室名字，医生和科室的映射也是绩效科室名字
4.这就导致了求当前数据时，因为筛选的部门使用的绩效科室名字，所以无法准确查出对应his编码，也就无法准确查出当前数据

WITH dep_incom AS (
  -- 查询当天实时数据
  SELECT 
    t_workload_inp_f.rcpt_date,
    t_workload_inp_f.patient_in_dept AS dep_code,
    t_workload_dep_def2his."绩效科室名称" AS dep_name,
    t_workload_inp_f.item_name,
    t_workload_inp_f.item_code,
    t_workload_inp_f.item_class_name,
    SUM(t_workload_inp_f.charges) AS charges,
    SUM(t_workload_inp_f.amount) AS amount
  FROM t_workload_inp_f 
  LEFT JOIN t_workload_dep_def2his 
    ON t_workload_dep_def2his."HIS科室编码"::text = t_workload_inp_f.patient_in_dept::text
  WHERE t_workload_inp_f.rcpt_date >= CURRENT_DATE 
    AND t_workload_inp_f.rcpt_date < CURRENT_DATE + 1
  GROUP BY 
    t_workload_inp_f.rcpt_date,
    t_workload_inp_f.patient_in_dept,
    t_workload_dep_def2his."绩效科室名称",
    t_workload_inp_f.item_name,
    t_workload_inp_f.item_code,
    t_workload_inp_f.item_class_name

  UNION ALL 

  -- 查询历史数据（从物化视图）
  SELECT 
    rcpt_date, 
    dep_code,
    dep_name,
    item_name,
    item_code,
    item_class_name,
    charges,
    amount 
  FROM t_dep_income_inp 
  WHERE rcpt_date < CURRENT_DATE
)
SELECT 
  SUM(charges) AS total_charges,
  SUM(amount) AS total_amount 
FROM dep_incom 
WHERE rcpt_date >= CURRENT_DATE-10 
    AND rcpt_date < CURRENT_DATE + 1





WITH doc_income AS (
  ----------------------------------------------------------------
  -- 1. 实时：t_workload_inp_f 当日及任意日期区间
  ----------------------------------------------------------------
  SELECT 
    f.rcpt_date::date          AS rcpt_date,
    f.order_doctor::text          AS doc_code,
    d.姓名::text                  AS doc_name,
    f.item_class_name::text       AS item_class_name,
    SUM(f.costs)::numeric         AS costs,
    SUM(f.amount)::numeric        AS amount
  FROM t_workload_inp_f f
  LEFT JOIN t_workload_doc_2dep_def d ON f.order_doctor = d.工号
  WHERE 
    f.rcpt_date >= '2025-11-10'::date
    AND f.rcpt_date < '2025-11-17'::date
    AND d.姓名 = '银元'
  GROUP BY 
    f.rcpt_date,
    f.order_doctor,
    d.姓名,
    f.item_class_name

  UNION ALL

----------------------------------------------------------------
  -- 2. 历史：物化视图 t_doc_fee_inp
  ----------------------------------------------------------------
  SELECT
    f.billing_date::date          AS billing_date,
    f.doc_code::text              AS doc_code,
    f.doc_name::text              AS doc_name,
    f.item_class_name::text       AS item_class_name,
    f.costs::numeric              AS costs,
    f.amount::numeric             AS amount
  FROM t_doc_fee_inp f
  WHERE
    f.billing_date >= '2025-11-10'::date
    AND f.billing_date < '2025-11-17'::date
    AND f.doc_name = '银元'
)
SELECT * FROM doc_income;
