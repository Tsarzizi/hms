## 汇总数据接口

### 请求参数

json

```
{
  "start_date": string,        // 开始日期 'YYYY-MM-DD'
  "end_date": string,          // 结束日期 'YYYY-MM-DD'
  "department_ids": string[],  // 科室ID数组（可选）
  "doctor_ids": string[]       // 医生ID数组（可选）
}
```



### 响应数据

json

```
{
  "success": boolean,
  "data": {
    "outpatientMedicalCostGrowthRate": { "value": number, "yoyChange": number, "momChange": number },
    "emergencyMedicalCostGrowthRate": { "value": number, "yoyChange": number, "momChange": number },
    "outpatientRevenueGrowthRate": { "value": number, "yoyChange": number, "momChange": number },
    "emergencyRevenueGrowthRate": { "value": number, "yoyChange": number, "momChange": number }
  },
  "message": string,
  "code": number
}
```



## 明细数据接口

### 请求参数

json

```
{
  "start_date": string,        // 开始日期 'YYYY-MM-DD'
  "end_date": string,          // 结束日期 'YYYY-MM-DD'
  "department_ids": string[],  // 科室ID数组（可选）
  "doctor_ids": string[]       // 医生ID数组（可选）
}
```



### 响应数据

json

```
{
  "success": boolean,
  "data": {
    "rows": Array<{
      "id": string,           // 唯一ID
      "date": string,         // 日期 'YYYY-MM-DD'
      "doctorName": string,   // 医生姓名
      "doctorCode": string,   // 医生工号
      "department": string,   // 科室名称
      "itemName": string,     // 项目名称
      "itemCode": string,     // 项目代码
      "itemClassName": string, // 项目类别名称
      "outpatientAmount": number,  // 门诊收入
      "emergencyAmount": number,   // 急诊收入
      "totalCosts": number,        // 总收入
      "patientCount": number       // 患者数
    }>,
    "total": number          // 总记录数
  },
  "message": string,
  "code": number
}
```



## 趋势数据接口

### 请求参数

json

```
{
  "start_date": string,        // 开始日期 'YYYY-MM-DD'
  "end_date": string,          // 结束日期 'YYYY-MM-DD'
  "department_ids": string[],  // 科室ID数组（可选）
  "doctor_ids": string[]       // 医生ID数组（可选）
}
```



### 响应数据

json

```
{
  "success": boolean,
  "data": {
    "rows": Array<{
      "date": string,         // 日期 'YYYY-MM-DD'
      "outpatientMedicalCostGrowthRate": number,  // 门诊患者医药费用增长率
      "emergencyMedicalCostGrowthRate": number,   // 急诊患者医药费用增长率
      "outpatientRevenueGrowthRate": number,      // 门诊收入增长率
      "emergencyRevenueGrowthRate": number        // 急诊收入增长率
    }>
  },
  "message": string,
  "code": number
}
```



## 数据库查询

### 科室列表查询

sql

```
SELECT DISTINCT 
  "绩效科室ID" as id, 
  "绩效科室名称" as name 
FROM t_workload_doc_2dep_def 
WHERE "在岗状态" = '在岗'
ORDER BY "绩效科室名称";
```



### 明细数据查询

sql

```
SELECT 
  t.visit_date as date,
  t.ordered_by_doctor as doctor_code,
  d."姓名" as doctor_name,
  d."绩效科室名称" as department,
  t.item_name,
  t.item_code,
  t.item_class_name,
  SUM(CASE WHEN t.item_class_name = '门诊' THEN t.costs ELSE 0 END) as outpatient_amount,
  SUM(CASE WHEN t.item_class_name = '急诊' THEN t.costs ELSE 0 END) as emergency_amount,
  SUM(t.costs) as total_costs,
  COUNT(DISTINCT t.patient_id) as patient_count
FROM t_workload_outp_f t
LEFT JOIN t_workload_doc_2dep_def d ON t.ordered_by_doctor = d."工号"
WHERE t.visit_date BETWEEN ? AND ?
  AND (? IS NULL OR d."绩效科室ID" IN (?))
  AND (? IS NULL OR t.ordered_by_doctor IN (?))
GROUP BY 
  t.visit_date,
  t.ordered_by_doctor, d."姓名", d."绩效科室名称",
  t.item_name, t.item_code, t.item_class_name
ORDER BY t.visit_date DESC;
```



### 趋势数据查询

sql

```
SELECT 
  visit_date as date,
  AVG(outpatient_medical_cost_growth_rate) as outpatient_medical_cost_growth_rate,
  AVG(emergency_medical_cost_growth_rate) as emergency_medical_cost_growth_rate,
  AVG(outpatient_revenue_growth_rate) as outpatient_revenue_growth_rate,
  AVG(emergency_revenue_growth_rate) as emergency_revenue_growth_rate
FROM (
  SELECT 
    visit_date,
    (SUM(CASE WHEN item_class_name = '门诊' THEN costs ELSE 0 END) - LAG(SUM(CASE WHEN item_class_name = '门诊' THEN costs ELSE 0 END)) OVER (ORDER BY visit_date)) 
    / LAG(SUM(CASE WHEN item_class_name = '门诊' THEN costs ELSE 0 END)) OVER (ORDER BY visit_date) * 100 
    as outpatient_medical_cost_growth_rate
  FROM t_workload_outp_f
  WHERE visit_date BETWEEN ? AND ?
    AND (? IS NULL OR ordered_by_doctor IN (SELECT "工号" FROM t_workload_doc_2dep_def WHERE "绩效科室ID" IN (?)))
    AND (? IS NULL OR ordered_by_doctor IN (?))
  GROUP BY visit_date
) growth_rates
GROUP BY visit_date
ORDER BY visit_date;
```



## 增长率计算规则

### 1. 门诊患者医药费用增长率

- **当前值**：选定时间段内门诊患者医药总费用
- **对比值**：对比时间段内门诊患者医药总费用
- **公式**：(当前值 - 对比值) / 对比值 × 100

### 2. 急诊患者医药费用增长率

- 同上，针对急诊患者

### 3. 门诊收入增长率

- **当前值**：选定时间段内门诊服务总收入
- **对比值**：对比时间段内门诊服务总收入
- **公式**：(当前值 - 对比值) / 对比值 × 100

### 4. 急诊收入增长率

- 同上，针对急诊服务

## 同比环比计算

### 同比（YoY）

- **对比时间段** = 去年同期（去年同月/同季度）

### 环比（MoM）

- **对比时间段** = 上一周期（上月/上季度）